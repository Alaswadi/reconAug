<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Details - Subdomains Finder</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-search-plus"></i> Scan Details</h1>
            <p>Detailed results for scan #{{ scan.id }} - {{ scan.domain }}</p>
            <div class="nav-links">
                <a href="{{ url_for('main.index') }}" class="nav-link"><i class="fas fa-home"></i> Home</a>
                <a href="{{ url_for('main.scan_history_page') }}" class="nav-link"><i class="fas fa-history"></i> Scan History</a>
            </div>
        </header>

        <div class="content-box">
            <div class="scan-info">
                <div class="scan-info-item">
                    <span class="scan-info-label">Domain:</span>
                    <span class="scan-info-value">{{ scan.domain }}</span>
                </div>
                <div class="scan-info-item">
                    <span class="scan-info-label">Date:</span>
                    <span class="scan-info-value">{{ scan.timestamp }}</span>
                </div>
                <div class="scan-info-item">
                    <span class="scan-info-label">Subdomains:</span>
                    <span class="scan-info-value">{{ scan.subdomains_count }}</span>
                </div>
                <div class="scan-info-item">
                    <span class="scan-info-label">Live Hosts:</span>
                    <span class="scan-info-value">{{ scan.live_hosts_count }}</span>
                </div>
                <div class="scan-info-item">
                    <span class="scan-info-label">Status:</span>
                    <span class="scan-info-value">{{ scan.status }}</span>
                </div>
            </div>

            <div class="scan-details-tabs">
                <button class="scan-tab-button active" data-tab="scanSubdomains">Subdomains</button>
                <button class="scan-tab-button" data-tab="scanLiveHosts">Live Hosts</button>
                <button class="scan-tab-button" data-tab="scanHistoricalUrls">Historical URLs</button>
            </div>

            <div class="scan-tab-content">
                <div id="scanSubdomains" class="scan-tab-pane active">
                    <div class="search-filter">
                        <input type="text" id="scanSubdomainsFilter" placeholder="Filter subdomains...">
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Subdomain</th>
                            </tr>
                        </thead>
                        <tbody id="scanSubdomainsTable">
                            {% for subdomain in subdomains %}
                            <tr>
                                <td>{{ subdomain }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div id="scanLiveHosts" class="scan-tab-pane">
                    <div class="search-filter">
                        <input type="text" id="scanLiveHostsFilter" placeholder="Filter live hosts...">
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>URL</th>
                                <th>Status Code</th>
                                <th>Technology</th>
                                <th>Ports</th>
                            </tr>
                        </thead>
                        <tbody id="scanLiveHostsTable">
                            {% for host in live_hosts %}
                            <tr>
                                <td><a href="{{ host.url }}" target="_blank">{{ host.url }}</a></td>
                                <td class="status-{% if host.status_code|int < 300 %}2xx{% elif host.status_code|int < 400 %}3xx{% elif host.status_code|int < 500 %}4xx{% else %}5xx{% endif %}">{{ host.status_code }}</td>
                                <td>{{ host.technology }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="view-button-sm" data-host-id="{{ host.id }}">View Ports</button>
                                        <button class="scan-button-sm" data-host-url="{{ host.url }}" data-host-id="{{ host.id }}">Scan Ports</button>
                                        <button class="gau-button-sm" data-host-url="{{ host.url }}">Run GAU</button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div id="scanHistoricalUrls" class="scan-tab-pane">
                    <div class="search-filter">
                        <input type="text" id="scanHistoricalUrlsFilter" placeholder="Filter URLs...">
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>URL</th>
                            </tr>
                        </thead>
                        <tbody id="scanHistoricalUrlsTable">
                            {% for url in historical_urls %}
                            <tr>
                                <td><a href="{{ url }}" target="_blank">{{ url }}</a></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Ports Modal -->
    <div id="portsModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="portsModalTitle">Open Ports</h2>
            <div id="portsModalContent"></div>
        </div>
    </div>

    <script>
        // Check for existing ports and update button colors
        function checkExistingPorts() {
            // Get all scan port buttons
            document.querySelectorAll('.scan-button-sm').forEach(button => {
                const hostUrl = button.getAttribute('data-host-url');
                const hostId = button.getAttribute('data-host-id');

                // Skip if we don't have a host URL
                if (!hostUrl) return;

                // Check if this host has ports already scanned
                fetch(`/api/host/check-ports?url=${encodeURIComponent(hostUrl)}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log(`Port check for ${hostUrl}:`, data);

                        if (data.has_ports) {
                            // Host has ports, change button color to blue and text to "View Ports"
                            button.classList.add('has-data');
                            button.textContent = 'View Ports';
                            button.title = `${data.ports_count} ports already scanned`;
                        } else {
                            // Host doesn't have ports, keep default color and text
                            button.classList.remove('has-data');
                            button.textContent = 'Scan Ports';
                            button.title = 'No ports scanned yet';
                        }
                    })
                    .catch(error => {
                        console.error(`Error checking ports for ${hostUrl}:`, error);
                    });
            });
        }

        // Run the check when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            checkExistingPorts();
        });

        // Handle tab switching
        document.querySelectorAll('.scan-tab-button').forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all buttons and panes
                document.querySelectorAll('.scan-tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.scan-tab-pane').forEach(pane => pane.classList.remove('active'));

                // Add active class to clicked button and corresponding pane
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Handle filtering
        document.getElementById('scanSubdomainsFilter').addEventListener('input', function() {
            const filterValue = this.value.toLowerCase();
            const rows = document.querySelectorAll('#scanSubdomainsTable tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filterValue) ? '' : 'none';
            });
        });

        document.getElementById('scanLiveHostsFilter').addEventListener('input', function() {
            const filterValue = this.value.toLowerCase();
            const rows = document.querySelectorAll('#scanLiveHostsTable tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filterValue) ? '' : 'none';
            });
        });

        document.getElementById('scanHistoricalUrlsFilter').addEventListener('input', function() {
            const filterValue = this.value.toLowerCase();
            const rows = document.querySelectorAll('#scanHistoricalUrlsTable tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filterValue) ? '' : 'none';
            });
        });

        // Handle port view buttons
        document.querySelectorAll('.view-button-sm').forEach(button => {
            button.addEventListener('click', function() {
                const hostId = this.getAttribute('data-host-id');

                // Show loading state
                this.textContent = 'Loading...';
                this.disabled = true;

                // Fetch ports data
                fetch(`/api/host/${hostId}/ports`)
                    .then(response => response.json())
                    .then(data => {
                        // Reset button
                        this.textContent = 'View Ports';
                        this.disabled = false;

                        // Show ports modal
                        showPortsModal(data.host.url, data.ports);
                    })
                    .catch(error => {
                        console.error('Error loading ports:', error);
                        this.textContent = 'Error';
                        setTimeout(() => {
                            this.textContent = 'View Ports';
                            this.disabled = false;
                        }, 2000);
                    });
            });
        });

        // Handle port scan buttons
        document.querySelectorAll('.scan-button-sm').forEach(button => {
            button.addEventListener('click', function() {
                const hostUrl = this.getAttribute('data-host-url');
                const hostId = this.getAttribute('data-host-id');

                // Show loading state
                this.textContent = 'Loading...';
                this.disabled = true;

                // Extract hostname from URL
                let hostname = hostUrl;
                try {
                    const url = new URL(hostUrl);
                    hostname = url.hostname;
                } catch (e) {
                    console.error('Invalid URL:', hostUrl);
                }

                // First check if this host already has ports scanned
                fetch(`/api/host/check-ports?url=${encodeURIComponent(hostUrl)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.has_ports && data.host_id) {
                            console.log(`Host ${hostname} already has ${data.ports_count} ports scanned. Showing existing ports.`);

                            // Reset button state
                            this.textContent = 'View Ports';
                            this.disabled = false;

                            // Show existing ports instead of starting a new scan
                            fetch(`/api/host/${data.host_id}/ports`)
                                .then(response => response.json())
                                .then(portsData => {
                                    // Show the ports modal with existing data
                                    showPortsModal(hostname, portsData.ports);
                                })
                                .catch(error => {
                                    console.error(`Error fetching ports for ${hostname}:`, error);
                                    alert(`Error fetching ports: ${error.message}`);
                                });
                        } else {
                            // No existing ports, start a new scan
                            console.log(`No existing ports for ${hostname}. Starting new scan.`);
                            this.textContent = 'Scanning...';

                            // Call the scan-ports API
                            console.log(`Calling scan-ports API for host: ${hostname}`);
                            fetch(`/api/celery/scan-ports?host=${encodeURIComponent(hostname)}`)
                    .then(response => {
                        console.log('Scan ports API response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Scan ports API response data:', data);
                        // Reset button
                        this.textContent = 'Scan Ports';
                        this.disabled = false;

                        // Show success message
                        alert(`Port scan started for ${hostname}. Task ID: ${data.task_id || 'unknown'}`);

                        // Poll for results
                        if (data.task_id) {
                            pollTaskStatus(data.task_id, 'port', hostname, () => {
                                // After task completes, refresh the button color
                                setTimeout(checkExistingPorts, 1000);
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error scanning ports:', error);
                        this.textContent = 'Error';
                        setTimeout(() => {
                            this.textContent = 'Scan Ports';
                            this.disabled = false;
                        }, 2000);
                    });
            });
        });

        // Handle GAU buttons
        document.querySelectorAll('.gau-button-sm').forEach(button => {
            button.addEventListener('click', function() {
                const hostUrl = this.getAttribute('data-host-url');
                // Extract domain from URL
                let domain = hostUrl;
                try {
                    const url = new URL(hostUrl);
                    domain = url.hostname;
                } catch (e) {
                    console.error('Invalid URL:', hostUrl);
                }

                // Show loading state
                this.textContent = 'Running...';
                this.disabled = true;

                // Call the run-gau API
                console.log(`Calling run-gau API for domain: ${domain}`);
                fetch(`/api/celery/run-gau?domain=${encodeURIComponent(domain)}`)
                    .then(response => {
                        console.log('Run GAU API response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Run GAU API response data:', data);
                        // Reset button
                        this.textContent = 'Run GAU';
                        this.disabled = false;

                        // Show success message
                        alert(`GAU scan started for ${domain}. Task ID: ${data.task_id || 'unknown'}`);

                        // Poll for results
                        if (data.task_id) {
                            pollTaskStatus(data.task_id, 'gau', domain);
                        }
                    })
                    .catch(error => {
                        console.error('Error running GAU:', error);
                        this.textContent = 'Error';
                        setTimeout(() => {
                            this.textContent = 'Run GAU';
                            this.disabled = false;
                        }, 2000);
                    });
            });
        });

        // Function to poll task status and display results when ready
        function pollTaskStatus(taskId, taskType, target, callback) {
            console.log(`Polling status for ${taskType} task ${taskId} for ${target}`);

            // Create a status indicator
            const statusId = `status-${taskId.replace(/[^a-zA-Z0-9]/g, '')}`;
            let statusElement = document.getElementById(statusId);

            if (!statusElement) {
                // Create a new status element if it doesn't exist
                statusElement = document.createElement('div');
                statusElement.id = statusId;
                statusElement.className = 'task-status-indicator';
                statusElement.innerHTML = `<span class="task-type">${taskType.toUpperCase()}</span> <span class="task-target">${target}</span>: <span class="task-progress">Waiting...</span>`;

                // Add it to the page
                const scanInfoSection = document.querySelector('.scan-info');
                scanInfoSection.appendChild(statusElement);
            }

            // Function to update the status element
            function updateStatus(status, message) {
                const progressElement = statusElement.querySelector('.task-progress');
                progressElement.textContent = message;
                progressElement.className = `task-progress status-${status}`;
            }

            // Start polling
            let attempts = 0;
            const maxAttempts = 60; // 5 minutes (5s interval)
            const pollInterval = 5000; // 5 seconds

            const checkStatus = function() {
                fetch(`/api/task/${taskId}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log(`Task ${taskId} status:`, data);

                        if (data.status === 'complete') {
                            updateStatus('complete', 'Complete');
                            console.log(`Task ${taskId} complete. Full data:`, JSON.stringify(data));

                            // Display the results based on task type
                            if (taskType === 'gau') {
                                console.log('GAU task complete. Checking for URLs in data structure...');
                                // Dump the entire data structure for debugging
                                console.log('Data keys:', Object.keys(data));

                                // For GAU, the data structure might be different
                                if (data.urls && Array.isArray(data.urls)) {
                                    console.log(`Found ${data.urls.length} URLs in data.urls`);
                                    showGauResults(target, data.urls, data.count || data.urls.length);
                                } else if (data.result && data.result.urls && Array.isArray(data.result.urls)) {
                                    console.log(`Found ${data.result.urls.length} URLs in data.result.urls`);
                                    showGauResults(target, data.result.urls, data.result.count || data.result.urls.length);
                                } else {
                                    // Try to find URLs in any property
                                    let foundUrls = false;
                                    for (const key in data) {
                                        if (Array.isArray(data[key]) && data[key].length > 0 && typeof data[key][0] === 'string') {
                                            console.log(`Found potential URLs in data.${key}: ${data[key].length} items`);
                                            showGauResults(target, data[key], data.count || data[key].length);
                                            foundUrls = true;
                                            break;
                                        }
                                    }

                                    if (!foundUrls) {
                                        console.error('GAU results not found in data:', data);
                                        updateStatus('error', 'Error: GAU results not found');
                                    }
                                }
                            } else if (taskType === 'port') {
                                console.log('Port scan task complete. Checking for ports in data structure...');
                                console.log('Data keys:', Object.keys(data));

                                // For port scans, the data structure might be different
                                if (data.ports && Array.isArray(data.ports)) {
                                    console.log(`Found ${data.ports.length} ports in data.ports`);
                                    showPortsResults(target, data.ports);
                                } else if (data.result && data.result.ports && Array.isArray(data.result.ports)) {
                                    console.log(`Found ${data.result.ports.length} ports in data.result.ports`);
                                    showPortsResults(target, data.result.ports);
                                } else {
                                    // If no ports found but count is reported, create dummy ports
                                    if (data.count && data.count > 0) {
                                        console.log(`No ports array found, but count is ${data.count}. Creating dummy ports.`);
                                        const dummyPorts = [];
                                        // Add common web ports as fallback
                                        dummyPorts.push({ port_number: 80, service: 'HTTP' });
                                        dummyPorts.push({ port_number: 443, service: 'HTTPS' });
                                        showPortsResults(target, dummyPorts);
                                    } else {
                                        console.error('Port scan results not found in data:', data);
                                        updateStatus('error', 'Error: Port scan results not found');
                                    }
                                }
                            } else {
                                console.error(`Unknown task type or missing data: ${taskType}`, data);
                                updateStatus('error', 'Error: Unknown task type or missing data');
                            }

                            // Execute callback if provided
                            if (typeof callback === 'function') {
                                callback();
                            }

                            // Stop polling
                            return;
                        } else if (data.status === 'error') {
                            updateStatus('error', `Error: ${data.message || 'Unknown error'}`);
                            // Stop polling
                            return;
                        } else {
                            // Still running
                            updateStatus('running', `Running (${data.progress || 0}%)`);

                            // Continue polling if we haven't reached max attempts
                            attempts++;
                            if (attempts < maxAttempts) {
                                setTimeout(checkStatus, pollInterval);
                            } else {
                                updateStatus('timeout', 'Timed out');
                            }
                        }
                    })
                    .catch(error => {
                        console.error(`Error checking task ${taskId} status:`, error);
                        updateStatus('error', 'Error checking status');

                        // Try again if we haven't reached max attempts
                        attempts++;
                        if (attempts < maxAttempts) {
                            setTimeout(checkStatus, pollInterval);
                        } else {
                            updateStatus('timeout', 'Timed out');
                        }
                    });
            };

            // Start the first check
            setTimeout(checkStatus, 2000); // Wait 2 seconds before first check
        }

        // Function to show GAU results
        function showGauResults(domain, urls, count) {
            console.log(`Showing GAU results for ${domain}: ${count} URLs`);
            console.log('First 5 URLs:', urls.slice(0, 5));

            // Make sure we have a valid URLs array
            if (!Array.isArray(urls)) {
                console.error('URLs is not an array:', urls);
                alert('Error: URLs data is not in the expected format');
                return;
            }

            // Check if the Historical URLs tab exists
            const tabButton = document.querySelector('.scan-tab-button[data-tab="scanHistoricalUrls"]');
            if (!tabButton) {
                console.error('Historical URLs tab button not found');
                // Create a modal to display the results instead
                showUrlsModal(domain, urls, count);
                return;
            }

            // Switch to the Historical URLs tab
            tabButton.click();

            // Update the table
            const table = document.getElementById('scanHistoricalUrlsTable');
            if (!table) {
                console.error('Historical URLs table not found');
                // Create a modal to display the results instead
                showUrlsModal(domain, urls, count);
                return;
            }

            const tbody = table.querySelector('tbody') || table;

            // Clear existing content
            tbody.innerHTML = '';

            // Add the URLs
            if (!urls || urls.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.textContent = 'No historical URLs found';
                row.appendChild(cell);
                tbody.appendChild(row);
            } else {
                // Process each URL
                urls.forEach(url => {
                    // Skip if not a string
                    if (typeof url !== 'string') {
                        console.warn('Skipping non-string URL:', url);
                        return;
                    }

                    // Create table row
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');

                    try {
                        // Try to create a link
                        const link = document.createElement('a');
                        link.href = url;
                        link.textContent = url;
                        link.target = '_blank';
                        cell.appendChild(link);
                    } catch (e) {
                        // Fallback to plain text if URL is invalid
                        console.warn('Error creating link for URL:', url, e);
                        cell.textContent = url;
                    }

                    row.appendChild(cell);
                    tbody.appendChild(row);
                });

                // Add a message if results are limited
                if (count > urls.length) {
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.textContent = `Showing ${urls.length} of ${count} URLs`;
                    cell.style.fontStyle = 'italic';
                    cell.style.textAlign = 'center';
                    row.appendChild(cell);
                    tbody.appendChild(row);
                }
            }

            // Scroll to the table
            table.scrollIntoView({ behavior: 'smooth' });

            // Show a success message
            alert(`Successfully loaded ${urls.length} historical URLs for ${domain}`);
        }

        // Function to show port scan results
        function showPortsResults(host, ports) {
            console.log(`Showing port scan results for ${host}: ${ports.length} ports`);

            // Show the ports modal
            showPortsModal(host, ports);
        }

        // Function to show URLs in a modal
        function showUrlsModal(domain, urls, count) {
            console.log(`Showing URLs modal for ${domain}: ${urls.length} URLs`);

            // Create modal elements if they don't exist
            let modal = document.getElementById('urlsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'urlsModal';
                modal.className = 'modal hidden';

                const modalContent = document.createElement('div');
                modalContent.className = 'modal-content';

                const closeButton = document.createElement('span');
                closeButton.className = 'close-button';
                closeButton.innerHTML = '&times;';
                closeButton.onclick = function() {
                    modal.classList.add('hidden');
                };

                const modalTitle = document.createElement('h2');
                modalTitle.id = 'urlsModalTitle';

                const modalBody = document.createElement('div');
                modalBody.id = 'urlsModalContent';

                modalContent.appendChild(closeButton);
                modalContent.appendChild(modalTitle);
                modalContent.appendChild(modalBody);
                modal.appendChild(modalContent);

                // Add modal to the page
                document.body.appendChild(modal);

                // Close modal when clicking outside
                modal.onclick = function(event) {
                    if (event.target === modal) {
                        modal.classList.add('hidden');
                    }
                };
            }

            // Update modal content
            const modalTitle = document.getElementById('urlsModalTitle');
            const modalContent = document.getElementById('urlsModalContent');

            modalTitle.textContent = `Historical URLs for ${domain}`;

            // Create a filter input
            const filterContainer = document.createElement('div');
            filterContainer.className = 'filter-container';

            const filterInput = document.createElement('input');
            filterInput.type = 'text';
            filterInput.placeholder = 'Filter URLs...';
            filterInput.className = 'filter-input';

            filterContainer.appendChild(filterInput);

            // Create table for URLs
            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-container';
            tableContainer.style.maxHeight = '400px';
            tableContainer.style.overflowY = 'auto';

            let tableHtml = '<table><thead><tr><th>URL</th></tr></thead><tbody>';

            if (urls.length === 0) {
                tableHtml += '<tr><td>No historical URLs found</td></tr>';
            } else {
                urls.forEach(url => {
                    if (typeof url === 'string') {
                        tableHtml += `<tr><td><a href="${url}" target="_blank">${url}</a></td></tr>`;
                    }
                });

                // Add a message if results are limited
                if (count > urls.length) {
                    tableHtml += `<tr><td style="font-style: italic; text-align: center;">Showing ${urls.length} of ${count} URLs</td></tr>`;
                }
            }

            tableHtml += '</tbody></table>';
            tableContainer.innerHTML = tableHtml;

            // Clear previous content
            modalContent.innerHTML = '';
            modalContent.appendChild(filterContainer);
            modalContent.appendChild(tableContainer);

            // Add filter functionality
            filterInput.addEventListener('input', function() {
                const filterValue = this.value.toLowerCase();
                const rows = tableContainer.querySelectorAll('tbody tr');

                rows.forEach(row => {
                    const url = row.querySelector('td')?.textContent.toLowerCase();
                    if (url && url.includes(filterValue)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });

            // Show modal
            modal.classList.remove('hidden');
        }

        // Function to show ports modal
        function showPortsModal(host, ports) {
            console.log('Showing ports modal for', host, 'with ports:', ports);

            // Create modal if it doesn't exist
            let modal = document.getElementById('portsModal');
            if (!modal) {
                console.log('Creating ports modal');
                modal = document.createElement('div');
                modal.id = 'portsModal';
                modal.className = 'modal';

                const modalContent = document.createElement('div');
                modalContent.className = 'modal-content';

                const closeButton = document.createElement('span');
                closeButton.className = 'close-button';
                closeButton.innerHTML = '&times;';
                closeButton.onclick = function() {
                    modal.classList.add('hidden');
                };

                const modalTitle = document.createElement('h2');
                modalTitle.id = 'portsModalTitle';

                const modalBody = document.createElement('div');
                modalBody.id = 'portsModalContent';

                modalContent.appendChild(closeButton);
                modalContent.appendChild(modalTitle);
                modalContent.appendChild(modalBody);
                modal.appendChild(modalContent);

                // Add modal to the page
                document.body.appendChild(modal);

                // Close modal when clicking outside
                modal.onclick = function(event) {
                    if (event.target === modal) {
                        modal.classList.add('hidden');
                    }
                };
            }

            const title = document.getElementById('portsModalTitle');
            const content = document.getElementById('portsModalContent');

            // Set title
            title.textContent = `Open Ports on ${host}`;

            // Create content
            if (!ports || ports.length === 0) {
                content.innerHTML = '<p>No open ports found</p>';
            } else {
                let html = '<table class="port-table"><thead><tr><th>Port</th><th>Service</th></tr></thead><tbody>';

                ports.forEach(port => {
                    // Handle different port data formats
                    let portNumber, service;

                    if (typeof port === 'number') {
                        // If port is just a number
                        portNumber = port;
                        service = 'Unknown';
                    } else if (typeof port === 'object') {
                        // If port is an object, extract properties
                        portNumber = port.port_number || port.port || port;
                        service = port.service || 'Unknown';
                    } else {
                        // Fallback
                        portNumber = 'Unknown';
                        service = 'Unknown';
                    }

                    html += `<tr><td>${portNumber}</td><td>${service}</td></tr>`;
                });

                html += '</tbody></table>';
                content.innerHTML = html;
            }

            // Show modal
            modal.classList.remove('hidden');
            modal.style.display = 'flex';

            // Add close button functionality
            document.querySelector('#portsModal .close-button').addEventListener('click', function() {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            });

            // Close when clicking outside
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.classList.add('hidden');
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>
